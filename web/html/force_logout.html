<!-- templates/force_logout.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Требуется повторная авторизация</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #dc3545;
            margin-bottom: 20px;
        }
        p {
            color: #666;
            margin: 10px 0;
        }
        .reason {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .loading {
            color: #007bff;
            font-weight: bold;
        }
        .noscript-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
    <script>
        (function() {
            document.getElementById('status').textContent = 'Очистка истории браузера...';

            // 1. Заменяем текущее состояние
            if (window.history.replaceState) {
                try {
                    history.replaceState(null, '', window.location.href);
                } catch (e) {
                    console.error('Ошибка замены состояния:', e);
                }
            }

            // 2. Добавляем временное состояние для логина
            if (window.history.pushState) {
                try {
                    history.pushState({authed: false}, '', '/');
                } catch (e) {
                    console.error('Ошибка добавления состояния:', e);
                }
            }

            // 3. Возвращаемся назад, удаляя текущую страницу из истории
            try {
                history.back();
            } catch (e) {
                console.error('Ошибка навигации назад:', e);
                // Если не удалось - сразу редирект
                setTimeout(function() {
                    window.location.replace('/login');
                }, 100);
                return;
            }

            // 4. Редирект на логин без добавления в историю
            setTimeout(function() {
                document.getElementById('status').textContent = 'Перенаправление на страницу входа...';
                window.location.replace('/login');
            }, 100);

            // 5. Фолбэк на случай если что-то пошло не так
            setTimeout(function() {
                window.location.replace('/login');
            }, 2000);

        })();
    </script>
</head>
<body>
<div class="container">
    <h2>Требуется повторная авторизация</h2>

    <div class="reason">
        <p><strong>Причина:</strong> {{.Reason}}</p>
        {{if .Timestamp}}
        <p><small>Время: {{.Timestamp}}</small></p>
        {{end}}
    </div>

    <p>Ваша сессия была завершена по соображениям безопасности.</p>
    <p>Для продолжения работы необходимо войти в систему заново.</p>

    <p class="loading" id="status">Начало безопасного выхода...</p>

    <noscript>
        <div class="noscript-warning">
            <p><strong>Внимание:</strong> JavaScript отключен в вашем браузере.</p>
            <p>Для безопасного выхода и очистки истории браузера необходимо включить JavaScript.</p>
            <p>Вы можете <a href="/login">перейти на страницу входа вручную</a>.</p>
        </div>
    </noscript>

    <div style="margin-top: 30px; font-size: 14px; color: #999;">
        <p>Если перенаправление не произошло автоматически в течение 3 секунд,
            <a href="/login">нажмите здесь для перехода на страницу входа</a>.</p>
    </div>
</div>
</body>
</html>